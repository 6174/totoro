<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width,initial-scale=1">
        <title>Totoro Test</title>
        <script src="/socket.io/socket.io.js"></script>
    </head>
    <body>
        <h1>Totoro Test</h1>
        <script>
            (function() {
                if (typeof console === 'undefined') {
                    console = {log:function(){}}
                }
                
                var orders = {}
                var timer
                var socket = io.connect('/labor')
                socket.on('connect', function(){
                    socket.emit('init', navigator.userAgent)
                    console.log('connected')
                })
                socket.on('ping', function(){
                    clearInterval(timer)
                })
                socket.on('addOrder', function(data){
                     var orderId = data.orderId
                    var src = 'runner/' + data.orderId + '/' + data.runner
                    var runInWindow = data.runInWindow
                    if(runInWindow){
                        var element = window.open(src, null, 'top=200,left=400,width=400,height=300')
                    }else{
                        var element = document.createElement('iframe')
                        element.src = src
                        document.body.appendChild(element)
                    }
                    orders[orderId] = {
                        runInWindow: runInWindow,
                        element: element
                    }
                    console.log('add order: ' + orderId + ' run in ' +
                             (runInWindow ? 'new window' : 'iframe'))
                })
                socket.on('removeOrder', function(orderId){
                    console.log('order interrupted: ' + orderId)
                    removeOrder(orderId)
                })
                socket.on('disconnect', function(){
                    console.log('disconnected')
                    for(var i in orders){
                        removeOrder(i)
                    }
                    timer = setInterval(function(){
                        socket.emit('ping')
                    }, 2000)
                })
                
                var reports = []
                window.report = function(data){
                    reports.push(data)
                    
                    if(data.action === 'end'){
                        var orderId = data.orderId
                        console.log('finish order: ' + orderId)
                        removeOrder(orderId)
                    }
                }
                setInterval(function(){
                    if(reports.length){
                        var data = reports
                        reports = []
                        socket.emit('report', data)
                        console.log('emit report data')
                    }
                },1000)
                
                function removeOrder(orderId){
                    var order = orders[orderId]
                    delete orders[orderId]
                    var runInWindow = order.runInWindow
                    var element = order.element
                    if(runInWindow){
                        element.close()
                    }else{
                        document.body.removeChild(element)
                    }
                    console.log('remove order: ' + orderId)
                 }
                
            })()
        </script>
    </body>
</html>
