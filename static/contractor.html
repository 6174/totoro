<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width,initial-scale=1">
        <title>Totoro Test</title>
        <script src="/socket.io/socket.io.js"></script>
    </head>
    <body>
        <h1>Totoro Test</h1>
        <script>
            (function() {
                var timer
                var socket = io.connect('/')
                socket.on('connect', function(){
                    socket.emit('ready', navigator.userAgent)
                    console.log('connected')
                })
                socket.on('ping', function(){
                    clearInterval(timer)
                })
                socket.on('newTask', function(data){
                    var ifm = document.createElement('iframe')
                    ifm.id = data.orderId
                    ifm.src = 'runner/' + data.orderId + '/' + data.runner
                    document.body.appendChild(ifm)
                })
                socket.on('disconnect', function(){
                    timer = setInterval(function(){
                        socket.emit('ping')
                    }, 2000)
                    console.log('disconnect')
                })
                
                var reports = []
                window.report = function(opts){
                    reports.push(opts)
                    if(opts.action === 'end'){
                        var orderId = opts.orderId
                        document.body.removeChild(document.getElementById(orderId))
                        console.log('finish test: ' + orderId)
                    }
                }
                setInterval(function(){
                    if(reports.length){
                        var temp = reports
                        reports = []
                        socket.emit('report', temp)
                    }
                }, 1000)
                
            })()
        </script>
    </body>
</html>
