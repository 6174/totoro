#!/usr/bin/env node

var fs = require('fs')
var path = require('path')
var commander = require('commander')
require('colorful').colorful()

var handleCfg = require('../lib/handle-cfg')

commander.helpInformation = function() {
    return [
        '',
        '  A simple, easy-to-use and stable front-end unit testing tool.'.to.cyan.color,
        '',
        '  Usage:'.to.green.color,
        '    ' + this._name + ' ' + this.usage(),
        '',
        '  Options:'.to.green.color,
        '' + this.optionHelp().replace(/^/gm, '    '),
        '',
        '  More Info:'.to.green.color,
        '    ' + 'https://github.com/totorojs/totoro'.to.underline.color,
        '',
        ''
    ].join('\n')
}

commander
    .option('-v, --version', 'output the version number')
    .option('--verbose', 'show debug log')
    .option('--runner [s]', 'runner path')
    .option('--browsers [s]', 'browsers to run test', split)
    .option('--adapter [s]', 'report adapter')
    .option('--charset [s]', 'charset')
    .option('--timeout [n]', 'client timeout')
    .option('--clientHost [s]', 'client server host')
    .option('--clientPort [n]', 'client server port')
    .option('--serverHost [s]', 'server host')
    .option('--serverPort [n]', 'server port')
    .option('--list', 'view available browsers')
    .parse(process.argv)

if (commander.rawArgs.length === 3 &&
        (commander.rawArgs[2] === '-v' || commander.rawArgs[2] === '--version')) {
    var pkgFile = path.join(__dirname, '..', 'package.json')
    var version = JSON.parse(fs.readFileSync(pkgFile)).version
    console.info(version)
    process.exit(0)
}

var cfg = getCfg(commander)
handleCfg(cfg)

if (cfg.list) {
    var list = require('../lib/list')
    list(cfg)
} else {
    var Client = require('../lib/client')
    new Client(cfg)
}


function split(str) {
    return str.split(',')
}

function getCfg(commander) {
    var cfg = {}
    commander.options.forEach(function(item, index, list) {
        var key = item.long.substring(2)
        if(key in commander) {
            cfg[key] = commander[key]
        }
    })
    ;delete cfg.version
    return cfg
}
